# 分布式系统
分布式系统就是把好多个小模块放在不同的主机上 ，然后用户是感觉不到他们分开的，感觉到是一个整体。
> AMS就是一个分布式系统。

### 分布式如何实现的呢：

- load balance:
- 多个node;
- 每个node可能有多个不同系统的instance
- 使用MQ，不同node是consumer；



### 分布式的好处：
- Disaster recovery，一个挂了还有另一个； 
- 并发多进程处理，提高效率 
- 灵活，哪个模块瓶颈了就加node;
- 一个主机并不是有全部的系统，一个主机可以开多node也可以停，降低耦合性，然后灵活，utilise资源。


### 分布式缓存： 
- Google Guava Cache ;

### 如何控制分布式的一致性：
- load balance： 一个访问请求被一个node拿到；

> 问题（如果一个节点拿到了data但是却坏了，这个时候已经把message consume了 怎么办）？

- DB加锁。（秒杀一类的）；
- 乐观锁，用version number来保证；  


### 如果在不同的DB，我们有需要保持事务的一致性，我们怎么办呢？ 
- 两阶段提交算法 :

```	

	比如我发请求给ABCD四个NODE。AB成功，CD挂掉了。 我需要AB也roll back。
	这个情况我需要两步，第一步发给ABCD，ABCD存储上一次的结果。ABCD return给发送者回应是否成功。
	只有当发送者接到成功的消息，发送者发第二次请求进行commit。 
	任何收不到或者受到错误，滚回。
	
	阶段1：请求阶段（commit-request phase，或称表决阶段，voting phase）。
	在请求阶段，协调者将通知事务参与者准备提交或取消事务，
	然后进入表决过程。在表决过程中，参与者将告知协调者自己的决策：同意（事务参与者本地作业执行成功）或取消（本地作业执行故障）。
	
	阶段2：提交阶段（commit phase）。
	在该阶段，协调者将基于第一个阶段的投票结果进行决策：提交或取消。
	当且仅当所有的参与者同意提交事务协调者才通知所有的参与者提交事务，否则协调者将通知所有的参与者取消事务。
	参与者在接收到协调者发来的消息后将执行响应的操作

```

## Load balance 的算法：

#### 轮询（Round Robin）
- 轮询算法把每个请求轮流发送到每个服务器上。下图中，一共有 6 个客户端产生了 6 个请求，这 6 个请求  按 (1, 2, 3, 4, 5, 6) 的顺序发送。 最后，(1, 3, 5) 的请求会被发送到服务器 1，(2, 4, 6) 的请求会被发送到服务器 


<img src="https://raw.githubusercontent.com/zeyao/TechNotes/master/Document/roundRobin.jpg" style="height:300px" />

- 这样存在一个问题，只能适用于性能差不多的服务器, 如果另一个服务器的性能较差，就不可以了

<img src="https://raw.githubusercontent.com/zeyao/TechNotes/master/Document/badRoundRobin.jpg" style="height:300px" />

#### 加权轮询（Weighted Round Robbin）； 根据服务器效率的配比；

- 加权轮询是在轮询的基础上，根据服务器的性能差异，为服务器赋予一定的权值。例如下图中，服务器 1 被赋予的权值为 5，服务器 2 被赋予的权值为 1，那么 (1, 2, 3, 4, 5) 请求会被发送到服务器 1，(6) 请求会被发送到服务器 2

<img src="https://raw.githubusercontent.com/zeyao/TechNotes/master/Document/加权轮询.jpg" style="height:300px" />


#### 最少连接（least Connections） 将请求发给现在有最少连接的；
- 由于每个请求的链接时间不一样，使用加权轮询或者轮询可能会让一台服务器的链接过大而另一台很少，造成不均衡
- 最少链接法就是将请求发送给最少链接的服务器上，如下图，服务器1当前连接数最少，新来的请求6就会发送到服务器1上面

<img src="https://raw.githubusercontent.com/zeyao/TechNotes/master/Document/最小链接.jpg" style="height:300px" />



#### 最少加权连接（Weighted Least Connection） 将请求发给现在有最少连接的；

- 在最小连接的基础上，根据服务器的性能为每台服务器分配权重，根据权重计算出每台服务器能处理的连接数

#### 随机链接






# Redis

### Redis 数据类型

- Redis支持五种数据类型：string（字符串），hash（哈希），list（列表），set（集合）及zset(sorted set：有序集合 

### Redis Hash

- Redis hash 是一个string类型的field和value的映射表，hash特别适合用于存储对象







- 保证消息具有唯一编号，可以通过日志进行backtrace。
